<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="欢迎访问[tianxia]的个人博客">
<meta name="author" content="kveln">
<title>ZipKin核心架构 | tianxia</title>
<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/bootstrap.min.css">
<link href="https://tinaxiawuhao.github.io/resource/all.min.css" rel="stylesheet">
<link rel="alternate" type="application/rss+xml" title="ZipKin核心架构 | tianxia » Feed"
  href="https://tinaxiawuhao.github.io/atom.xml">
<link rel="stylesheet"
  href="https://tinaxiawuhao.github.io/resource/androidstudio.min.css">
<link href="https://tinaxiawuhao.github.io/styles/main.css" rel="stylesheet">
<script src="https://tinaxiawuhao.github.io/resource/jquery.min.js"></script>

<script src="https://tinaxiawuhao.github.io/resource/highlight.min.js"></script>

<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

  <meta property="og:description" content="ZipKin核心架构" />
  <meta property="og:url" content="https://tinaxiawuhao.github.io/post/OTKk-Bytc/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="tianxia" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1660659241544"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1660659241544"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://tinaxiawuhao.github.io/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- 没Title为其他页面Header -->
          
            <!-- 没Title并且有headerType为Post：文章Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://tinaxiawuhao.github.io/tag/PvdavFGm6/" class="tag">springCloud</a>
                
              </span>
              <h1>ZipKin核心架构</h1>
              <span class="meta">
                Posted on
                2022-07-14，14 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <img class="post-feature-header-image" src="https://tinaxiawuhao.github.io/post-images/OTKk-Bytc.png" alt="封面图">
          </img>
          
          <h2 id="zipkin核心架构">ZipKin核心架构</h2>
<p>Zipkin 是 Twitter 的一个开源项目，它基于Google Dapper论文实现，可以收集微服务运行过程中的实时链路数据，并进行展示。</p>
<h3 id="zipkin概述">ZipKin概述</h3>
<p>Zipkin是一种分布式链路跟踪系统，能够收集微服务运行过程中的实时调用链路信息，并能够将这些调用链路信息展示到Web界面上供开发人员分析，开发人员能够从ZipKin中分析出调用链路中的性能瓶颈，识别出存在问题的应用程序，进而定位问题和解决问题。</p>
<h3 id="zipkin核心架构-2">ZipKin核心架构</h3>
<p>ZipKin的核心架构图如下所示。</p>
<figure data-type="image" tabindex="1"><img src="https://tinaxiawuhao.github.io/post-images/1658669584317.png" alt="" loading="lazy"></figure>
<p>注：图片来源：zipkin.io/pages/architecture.html</p>
<p>其中，ZipKin核心组件的功能如下所示。</p>
<ul>
<li>Reporter：ZipKin中上报链路数据的模块，主要配置在具体的微服务应用中。</li>
<li>Transport：ZipKin中传输链路数据的模块，此模块可以配置为Kafka，RocketMQ、RabbitMQ等。</li>
<li>Collector：ZipKin中收集并消费链路数据的模块，默认是通过http协议收集，可以配置为Kafka消费。</li>
<li>Storage：ZipKin中存储链路数据的模块，此模块的具体可以配置为ElasticSearch、Cassandra或者MySQL，目前ZipKin支持这三种数据持久化方式。</li>
<li>API：ZipKin中的API 组件，主要用来提供外部访问接口。比如给客户端展示跟踪信息，或是开放给外部系统实现监控等。</li>
<li>UI：ZipKin中的UI 组件，基于API组件实现的上层应用。通过UI组件用户可以方便并且很直观地查询和分析跟踪信息。</li>
</ul>
<p>Zipkin在总体上会分为两个端，一个是Zipkin服务端，一个是Zipkin客户端，客户端主要是配置在微服务应用中，收集微服务中的调用链路信息，将数据发送给ZipKin服务端。</p>
<h2 id="项目整合zipkin">项目整合ZipKin</h2>
<p>Zipkin总体上分为服务端和客户端，我们需要下载并启动ZipKin服务端的Jar包，在微服务中集成ZipKin的客户端。</p>
<h3 id="下载安装zipkin服务端">下载安装ZipKin服务端</h3>
<p>（1）下载ZipKin服务端Jar文件，可以直接在浏览器中输入如下链接进行下载。</p>
<pre><code class="language-java">https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec
</code></pre>
<p>如果大家使用的是Linux操作系统，也可以在命令行输入如下命令进行下载。</p>
<pre><code class="language-java">wget https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec
</code></pre>
<p>这里，我通过浏览器下载的ZipKin服务端Jar文件为：zipkin-server-2.12.9-exec.jar。</p>
<p>（2）在命令行输入如下命令启动ZipKin服务端。</p>
<pre><code class="language-java">java -jar zipkin-server-2.12.9-exec.jar
</code></pre>
<p>（3）由于ZipKin服务端启动时，默认监听的端口号为9411，所以，在浏览器中输入<code>http://localhost:9411</code>链接就可以打开ZipKin的界面，如下所示。</p>
<figure data-type="image" tabindex="2"><img src="https://tinaxiawuhao.github.io/post-images/1658669599290.png" alt="" loading="lazy"></figure>
<p>在浏览器中输入<code>http://localhost:9411</code>链接能够打开上述页面就说明ZipKin服务端已经准备好啦。</p>
<h3 id="项目整合zipkin客户端">项目整合ZipKin客户端</h3>
<p>（1）在每个微服务（用户微服务shop-user，商品微服务shop-product，订单微服务shop-order，网关服务shop-gateway）中添加ZipKin依赖，如下所示。</p>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>（2）在网关服务shop-gateway的application.yml文件中添加如下配置。</p>
<pre><code class="language-java">spring:
  sleuth:
    sampler:
      probability: 1.0
  zipkin:
    base-url: http://127.0.0.1:9411
    discovery-client-enabled: false
</code></pre>
<p>其中各配置的说明如下所示。</p>
<ul>
<li>spring.sleuth.sampler.probability：表示Sleuth的采样百分比。</li>
<li>spring.zipkin.base-url：ZipKin服务端的地址。</li>
<li>spring.zipkin.discovery-client-enabled：配置成false，使Nacos将其当成一个URL，不要按服务名处理。</li>
</ul>
<p>（3）分别启动用户微服务，商品微服务，订单微服务和服务网关，在浏览器中访问链接<code>http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1</code>，如下所示。</p>
<figure data-type="image" tabindex="3"><img src="https://tinaxiawuhao.github.io/post-images/1658669612230.png" alt="" loading="lazy"></figure>
<p>（4）点击Zipkin界面上的查找按钮，如下所示。</p>
<figure data-type="image" tabindex="4"><img src="https://tinaxiawuhao.github.io/post-images/1658669621403.png" alt="" loading="lazy"></figure>
<p>点击后的界面如下所示。</p>
<figure data-type="image" tabindex="5"><img src="https://tinaxiawuhao.github.io/post-images/1658669630450.png" alt="" loading="lazy"></figure>
<p>可以看到，点击查找按钮后，会出现一个请求链路，包含：网关服务server-gateway耗时63.190毫秒，订单微服务server-order耗时53.101毫秒，用户微服务server-user耗时14.640毫秒，商品微服务server-product耗时10.941毫秒。</p>
<p>（5）点开ZipKin界面上显示的调用链路，如下所示。</p>
<figure data-type="image" tabindex="6"><img src="https://tinaxiawuhao.github.io/post-images/1658669639633.png" alt="" loading="lazy"></figure>
<p>点开后的界面如下所示。</p>
<figure data-type="image" tabindex="7"><img src="https://tinaxiawuhao.github.io/post-images/1658669648357.png" alt="" loading="lazy"></figure>
<p>可以非常清晰的看到整个调用的访问链路。</p>
<p>我们还可以点击具体的节点来查看具体的调用信息。</p>
<p>例如我们点击网关微服务查看网关的具体链路，如下所示。</p>
<figure data-type="image" tabindex="8"><img src="https://tinaxiawuhao.github.io/post-images/1658669660361.png" alt="" loading="lazy"></figure>
<p>点开后的效果如下所示。</p>
<figure data-type="image" tabindex="9"><img src="https://tinaxiawuhao.github.io/post-images/1658669669867.png" alt="" loading="lazy"></figure>
<p>接下来，查看下订单微服务的调用链路具体信息，如下所示。</p>
<figure data-type="image" tabindex="10"><img src="https://tinaxiawuhao.github.io/post-images/1658669680389.png" alt="" loading="lazy"></figure>
<p>点开后的效果如下所示。</p>
<figure data-type="image" tabindex="11"><img src="https://tinaxiawuhao.github.io/post-images/1658669689570.png" alt="" loading="lazy"></figure>
<p>可以看到，通过ZipKin能够查看服务的调用链路，并且能够查看具体微服务的调用情况。我们可以基于ZipKin来分析系统的调用链路情况，找出系统的瓶颈点，进而进行针对性的优化。</p>
<p>另外，ZipKin中也支持下载系统调用链路的Json数据，如下所示。</p>
<figure data-type="image" tabindex="12"><img src="https://tinaxiawuhao.github.io/post-images/1658669701393.png" alt="" loading="lazy"></figure>
<p>点击JSON按钮后，效果如下所示。</p>
<figure data-type="image" tabindex="13"><img src="https://tinaxiawuhao.github.io/post-images/1658669710853.png" alt="" loading="lazy"></figure>
<p>其中，显示的Json数据如下所示。</p>
<pre><code class="language-java">[
  [
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;5f0932b5d06fe757&quot;,
      &quot;kind&quot;: &quot;SERVER&quot;,
      &quot;name&quot;: &quot;get /get/{pid}&quot;,
      &quot;timestamp&quot;: 1652413758790051,
      &quot;duration&quot;: 10941,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-product&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;,
        &quot;port&quot;: 54140
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/product/get/1001&quot;,
        &quot;mvc.controller.class&quot;: &quot;ProductController&quot;,
        &quot;mvc.controller.method&quot;: &quot;getProduct&quot;
      },
      &quot;shared&quot;: true
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;c020c7f6e0fa1604&quot;,
      &quot;kind&quot;: &quot;SERVER&quot;,
      &quot;name&quot;: &quot;get /update_count/{pid}/{count}&quot;,
      &quot;timestamp&quot;: 1652413758808052,
      &quot;duration&quot;: 5614,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-product&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;,
        &quot;port&quot;: 54140
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/product/update_count/1001/1&quot;,
        &quot;mvc.controller.class&quot;: &quot;ProductController&quot;,
        &quot;mvc.controller.method&quot;: &quot;updateCount&quot;
      },
      &quot;shared&quot;: true
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;id&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;kind&quot;: &quot;CLIENT&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758763816,
      &quot;duration&quot;: 54556,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-gateway&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;,
        &quot;port&quot;: 8080
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/order/submit_order&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;id&quot;: &quot;475ff483fb0973b1&quot;,
      &quot;kind&quot;: &quot;CLIENT&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758759023,
      &quot;duration&quot;: 59621,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-gateway&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/order/submit_order&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;id&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;kind&quot;: &quot;SERVER&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758757034,
      &quot;duration&quot;: 63190,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-gateway&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;127.0.0.1&quot;,
        &quot;port&quot;: 54137
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/server-order/order/submit_order&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;a048eda8d5fd3dc9&quot;,
      &quot;kind&quot;: &quot;CLIENT&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758774201,
      &quot;duration&quot;: 12054,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-order&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/user/get/1001&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;5f0932b5d06fe757&quot;,
      &quot;kind&quot;: &quot;CLIENT&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758787924,
      &quot;duration&quot;: 12557,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-order&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/product/get/1001&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;c020c7f6e0fa1604&quot;,
      &quot;kind&quot;: &quot;CLIENT&quot;,
      &quot;name&quot;: &quot;get&quot;,
      &quot;timestamp&quot;: 1652413758805787,
      &quot;duration&quot;: 7031,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-order&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/product/update_count/1001/1&quot;
      }
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;id&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;kind&quot;: &quot;SERVER&quot;,
      &quot;name&quot;: &quot;get /submit_order&quot;,
      &quot;timestamp&quot;: 1652413758765048,
      &quot;duration&quot;: 53101,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-order&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;127.0.0.1&quot;
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/order/submit_order&quot;,
        &quot;mvc.controller.class&quot;: &quot;OrderController&quot;,
        &quot;mvc.controller.method&quot;: &quot;submitOrder&quot;
      },
      &quot;shared&quot;: true
    },
    {
      &quot;traceId&quot;: &quot;9d244edbc1668d92&quot;,
      &quot;parentId&quot;: &quot;3f01ba499fac4ce9&quot;,
      &quot;id&quot;: &quot;a048eda8d5fd3dc9&quot;,
      &quot;kind&quot;: &quot;SERVER&quot;,
      &quot;name&quot;: &quot;get /get/{uid}&quot;,
      &quot;timestamp&quot;: 1652413758777073,
      &quot;duration&quot;: 14640,
      &quot;localEndpoint&quot;: {
        &quot;serviceName&quot;: &quot;server-user&quot;,
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;
      },
      &quot;remoteEndpoint&quot;: {
        &quot;ipv4&quot;: &quot;192.168.0.111&quot;,
        &quot;port&quot;: 54139
      },
      &quot;tags&quot;: {
        &quot;http.method&quot;: &quot;GET&quot;,
        &quot;http.path&quot;: &quot;/user/get/1001&quot;,
        &quot;mvc.controller.class&quot;: &quot;UserController&quot;,
        &quot;mvc.controller.method&quot;: &quot;getUser&quot;
      },
      &quot;shared&quot;: true
    }
  ]
]
</code></pre>
<p>小伙伴们也可以根据Json数据分析下系统的调用链路。</p>
<h2 id="zipkin数据持久化">ZipKin数据持久化</h2>
<p>我们实现了在项目中集成ZipKin，但是此时我们集成ZipKin后，ZipKin中的数据是保存在系统内存中的，如果我们重启了ZipKin，则保存在系统内存中的数据就会丢失，那我如何避免数据丢失呢？ZipKin支持将数据进行持久化来防止数据丢失，可以将数据保存到ElasticSearch、Cassandra或者MySQL中。这里，我们重点介绍下如何将数据保存到MySQL和ElasticSearch中。</p>
<h3 id="zipkin数据持久化到mysql">ZipKin数据持久化到MySQL</h3>
<p>（1）将Zipkin数据持久化到MySQL，我们需要知道MySQL的数据表结构，好在ZipKin提供了MySQL脚本，小伙伴们可以在链接：https://github.com/openzipkin/zipkin/tree/master/zipkin-storage里面下载。</p>
<figure data-type="image" tabindex="14"><img src="https://tinaxiawuhao.github.io/post-images/1658669727877.png" alt="" loading="lazy"></figure>
<p>当然，我将下载后的MySQL脚本放到了网关服务shop-gateway的resources目录下的scripts目录下。</p>
<figure data-type="image" tabindex="15"><img src="https://tinaxiawuhao.github.io/post-images/1658669734767.png" alt="" loading="lazy"></figure>
<p>（2）在MySQL数据库中新建zipkin数据库，如下所示。</p>
<pre><code class="language-java">create database if not exists zipkin;
</code></pre>
<p>（3）在新建的数据库zipkin中运行mysql.sql脚本，运行脚本后的效果如下所示。</p>
<figure data-type="image" tabindex="16"><img src="https://tinaxiawuhao.github.io/post-images/1658669743490.png" alt="" loading="lazy"></figure>
<p>可以看到，在zipkin数据库中新建了zipkin_annotations、zipkin_dependencies和zipkin_spans三张数据表。</p>
<p>（4）启动ZipKin时指定MySQL数据源，如下所示。</p>
<pre><code class="language-java">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=mysql --MYSQL_HOST=127.0.0.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root --MYSQL_PASS=root
</code></pre>
<p>（5）启动ZipKin后，在浏览器中访问链接<code>http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1</code>，如下所示。</p>
<figure data-type="image" tabindex="17"><img src="https://tinaxiawuhao.github.io/post-images/1658669752307.png" alt="" loading="lazy"></figure>
<p>（6）查看zipkin数据库中的数据，发现zipkin_annotations数据表与zipkin_spans数据表已经存在系统的调用链路数据。</p>
<ul>
<li>zipkin_annotations数据表部分数据如下所示。</li>
</ul>
<figure data-type="image" tabindex="18"><img src="https://tinaxiawuhao.github.io/post-images/1658669758514.png" alt="" loading="lazy"></figure>
<ul>
<li>zipkin_spans数据表部分数据如下所示。</li>
</ul>
<figure data-type="image" tabindex="19"><img src="https://tinaxiawuhao.github.io/post-images/1658669768628.png" alt="" loading="lazy"></figure>
<p>可以看到，ZipKin已经将数据持久化到MySQL中，重启ZipKin后就会从MySQL中读取数据，数据也不会丢失了。</p>
<h3 id="zipkin数据持久化到elasticsearch">ZipKin数据持久化到ElasticSearch</h3>
<p>（1）到ElasticSearch官网下载ElasticSearch，链接为：</p>
<p>https://www.elastic.co/cn/downloads/elasticsearch。</p>
<p>这里下载的安装包是：elasticsearch-8.2.0-windows-x86_64.zip。</p>
<p>（2）解压elasticsearch-8.2.0-windows-x86_64.zip，在解压后的bin目录下找到elasticsearch.bat脚本，双击运行ElasticSearch。</p>
<p>（3）启动ZipKin服务端时，指定ElasticSearch，如下所示。</p>
<pre><code class="language-java">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=elasticsearch --ESHOST=localhost:9200
</code></pre>
<p>（4）启动ZipKin服务端后，在浏览器中访问链接<code>http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1</code>，如下所示。</p>
<figure data-type="image" tabindex="20"><img src="https://tinaxiawuhao.github.io/post-images/1658669778050.png" alt="" loading="lazy"></figure>
<p>ZipKin就会将请求的链路信息保存到ElasticSearch中进行持久化。</p>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#zipkin%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84">ZipKin核心架构</a>
<ul>
<li><a href="#zipkin%E6%A6%82%E8%BF%B0">ZipKin概述</a></li>
<li><a href="#zipkin%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84-2">ZipKin核心架构</a></li>
</ul>
</li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88zipkin">项目整合ZipKin</a>
<ul>
<li><a href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85zipkin%E6%9C%8D%E5%8A%A1%E7%AB%AF">下载安装ZipKin服务端</a></li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88zipkin%E5%AE%A2%E6%88%B7%E7%AB%AF">项目整合ZipKin客户端</a></li>
</ul>
</li>
<li><a href="#zipkin%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96">ZipKin数据持久化</a>
<ul>
<li><a href="#zipkin%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0mysql">ZipKin数据持久化到MySQL</a></li>
<li><a href="#zipkin%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0elasticsearch">ZipKin数据持久化到ElasticSearch</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
          
              <hr />
            
          
            
            <p class="next-post">上一篇：
                <a href="https://tinaxiawuhao.github.io/post/ZbHW6UCYN/">
                  <span class="post-title">
                    Sleuth概述&rarr;
                  </span>
                </a>
              </p>
            
          
            
           <p class="prev-post">下一篇：
                 <a href="https://tinaxiawuhao.github.io/post/t9Kci8xf6/">
                   <span class="post-title">
                     nocas长轮询&rarr;
                   </span>
                 </a>
               </p>
          
          <div class="comment" style="text-align: center;">
            

            
            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/tinaxiawuhao" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://tinaxiawuhao.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>tianxia</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/clean-blog.min.js"></script> -->
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="240" height="250" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //移动端
        console.log("------ 移动端");
    } else {
        console.log("------ PC端 " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // 加载完成后再loadlive2d
            loadlive2d("live2d", "https://tinaxiawuhao.github.io/media/live2d/assets/tororo.model.json");
        });

        var home_Path = "https://tinaxiawuhao.github.io/";
        addScript("https://tinaxiawuhao.github.io/media/live2d/js/message.js", () => { });
    }

    // 插入js文件，完成后callback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();如果传递字符串过来 调用window['函数名']() 调用方法
                }
            }
        };
    }
</script>
  
  <script src="https://tinaxiawuhao.github.io/media/scripts/tocScript.js"></script>
</body>

</html>