<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="欢迎访问[tianxia]的个人博客">
<meta name="author" content="kveln">
<title>Seata | tianxia</title>
<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/bootstrap.min.css">
<link href="https://tinaxiawuhao.github.io/resource/all.min.css" rel="stylesheet">
<link rel="alternate" type="application/rss+xml" title="Seata | tianxia » Feed"
  href="https://tinaxiawuhao.github.io/atom.xml">
<link rel="stylesheet"
  href="https://tinaxiawuhao.github.io/resource/androidstudio.min.css">
<link href="https://tinaxiawuhao.github.io/styles/main.css" rel="stylesheet">
<script src="https://tinaxiawuhao.github.io/resource/jquery.min.js"></script>

<script src="https://tinaxiawuhao.github.io/resource/highlight.min.js"></script>

<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

  <meta property="og:description" content="Seata" />
  <meta property="og:url" content="https://tinaxiawuhao.github.io/post/XFKzbOO8H/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="tianxia" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1660659241544"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1660659241544"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://tinaxiawuhao.github.io/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- 没Title为其他页面Header -->
          
            <!-- 没Title并且有headerType为Post：文章Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://tinaxiawuhao.github.io/tag/PvdavFGm6/" class="tag">springCloud</a>
                
              </span>
              <h1>Seata</h1>
              <span class="meta">
                Posted on
                2022-07-18，9 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <img class="post-feature-header-image" src="https://tinaxiawuhao.github.io/post-images/XFKzbOO8H.png" alt="封面图">
          </img>
          
          <h3 id="seata-是什么">Seata 是什么?</h3>
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<figure data-type="image" tabindex="1"><img src="https://tinaxiawuhao.github.io/post-images/1659011805071.png" alt="" loading="lazy"></figure>
<h3 id="at-模式">AT 模式</h3>
<h4 id="前提">前提</h4>
<ul>
<li>基于支持本地 ACID 事务的关系型数据库。</li>
<li>Java 应用，通过 JDBC 访问数据库。</li>
</ul>
<h4 id="整体机制">整体机制</h4>
<p>两阶段提交协议的演变：</p>
<ul>
<li>
<p>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</p>
</li>
<li>
<p>二阶段：</p>
</li>
<li>
<ul>
<li>提交异步化，非常快速地完成。</li>
<li>回滚通过一阶段的回滚日志进行反向补偿。</li>
</ul>
</li>
</ul>
<h4 id="写隔离">写隔离</h4>
<ul>
<li>一阶段本地事务提交前，需要确保先拿到 <strong>「全局锁」</strong> 。</li>
<li>拿不到 <strong>「全局锁」</strong> ，不能提交本地事务。</li>
<li>拿 <strong>「全局锁」</strong> 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。</li>
</ul>
<p>以一个示例来说明：</p>
<p>两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000。</p>
<p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 <strong>「全局锁」</strong> ，本地提交释放本地锁。tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 <strong>「全局锁」</strong> ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 <strong>「全局锁」</strong> 。</p>
<figure data-type="image" tabindex="2"><img src="https://tinaxiawuhao.github.io/post-images/1659011821117.png" alt="" loading="lazy"></figure>
<p>tx1 二阶段全局提交，释放 <strong>「全局锁」</strong> 。tx2 拿到 <strong>「全局锁」</strong> 提交本地事务。</p>
<figure data-type="image" tabindex="3"><img src="https://tinaxiawuhao.github.io/post-images/1659011828070.png" alt="" loading="lazy"></figure>
<p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。</p>
<p>此时，如果 tx2 仍在等待该数据的 <strong>「全局锁」</strong>，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 <strong>「全局锁」</strong> 等锁超时，放弃 <strong>「全局锁」</strong> 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p>
<p>因为整个过程 <strong>「全局锁」</strong> 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 <strong>「脏写」</strong> 的问题。</p>
<h4 id="读隔离">读隔离</h4>
<p>在数据库本地事务隔离级别 <strong>「读已提交（Read Committed）」</strong> 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>「读未提交（Read Uncommitted）」</strong> 。</p>
<p>如果应用在特定场景下，必需要求全局的 <strong>「读已提交」</strong> ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。</p>
<figure data-type="image" tabindex="4"><img src="https://tinaxiawuhao.github.io/post-images/1659011835961.png" alt="" loading="lazy"></figure>
<p>SELECT FOR UPDATE 语句的执行会申请 <strong>「全局锁」</strong> ，如果 <strong>「全局锁」</strong> 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>「全局锁」</strong> 拿到，即读取的相关数据是 <strong>「已提交」</strong> 的，才返回。</p>
<p>出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。</p>
<h4 id="工作机制">工作机制</h4>
<p>以一个示例来说明整个 AT 分支的工作过程。</p>
<p>业务表：<code>product</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Key</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">bigint(20)</td>
<td style="text-align:left">PRI</td>
</tr>
<tr>
<td style="text-align:left">name</td>
<td style="text-align:left">varchar(100)</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">since</td>
<td style="text-align:left">varchar(100)</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>AT 分支事务的业务逻辑：</p>
<pre><code class="language-sql">update product set name = 'GTS' where name = 'TXC';
</code></pre>
<p><strong>「一阶段」</strong></p>
<p>过程：</p>
<ol>
<li>解析 SQL：得到 SQL 的类型（UPDATE），表（product），条件（where name = 'TXC'）等相关的信息。</li>
<li>查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据。</li>
</ol>
<pre><code class="language-sql">select id, name, since from product where name = 'TXC';
</code></pre>
<p>得到前镜像：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
<th style="text-align:left">since</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">TXC</td>
<td style="text-align:left">2014</td>
</tr>
</tbody>
</table>
<ol>
<li>执行业务 SQL：更新这条记录的 name 为 'GTS'。</li>
<li>查询后镜像：根据前镜像的结果，通过 <strong>「主键」</strong> 定位数据。</li>
</ol>
<pre><code class="language-sql">select id, name, since from product where id = 1;
</code></pre>
<p>得到后镜像：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
<th style="text-align:left">since</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">GTS</td>
<td style="text-align:left">2014</td>
</tr>
</tbody>
</table>
<ol>
<li>插入回滚日志：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中。</li>
</ol>
<pre><code class="language-json">{
 &quot;branchId&quot;: 641789253,
 &quot;undoItems&quot;: [{
  &quot;afterImage&quot;: {
   &quot;rows&quot;: [{
    &quot;fields&quot;: [{
     &quot;name&quot;: &quot;id&quot;,
     &quot;type&quot;: 4,
     &quot;value&quot;: 1
    }, {
     &quot;name&quot;: &quot;name&quot;,
     &quot;type&quot;: 12,
     &quot;value&quot;: &quot;GTS&quot;
    }, {
     &quot;name&quot;: &quot;since&quot;,
     &quot;type&quot;: 12,
     &quot;value&quot;: &quot;2014&quot;
    }]
   }],
   &quot;tableName&quot;: &quot;product&quot;
  },
  &quot;beforeImage&quot;: {
   &quot;rows&quot;: [{
    &quot;fields&quot;: [{
     &quot;name&quot;: &quot;id&quot;,
     &quot;type&quot;: 4,
     &quot;value&quot;: 1
    }, {
     &quot;name&quot;: &quot;name&quot;,
     &quot;type&quot;: 12,
     &quot;value&quot;: &quot;TXC&quot;
    }, {
     &quot;name&quot;: &quot;since&quot;,
     &quot;type&quot;: 12,
     &quot;value&quot;: &quot;2014&quot;
    }]
   }],
   &quot;tableName&quot;: &quot;product&quot;
  },
  &quot;sqlType&quot;: &quot;UPDATE&quot;
 }],
 &quot;xid&quot;: &quot;xid:xxx&quot;
}
</code></pre>
<ol>
<li>提交前，向 TC 注册分支：申请 <code>product</code> 表中，主键值等于 1 的记录的 <strong>「全局锁」</strong> 。</li>
<li>本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。</li>
<li>将本地事务提交的结果上报给 TC。</li>
</ol>
<p><strong>「二阶段-回滚」</strong></p>
<ol>
<li>收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</li>
<li>通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</li>
<li>数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。</li>
<li>根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句：</li>
</ol>
<pre><code class="language-sql">update product set name = 'TXC' where id = 1;
</code></pre>
<ol>
<li>提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</li>
</ol>
<p><strong>「二阶段-提交」</strong></p>
<ol>
<li>收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li>
<li>异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</li>
</ol>
<h4 id="附录">附录</h4>
<p><strong>「回滚日志表」</strong></p>
<p>UNDO_LOG Table：不同数据库在类型上会略有差别。</p>
<p>以 MySQL 为例：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">branch_id</td>
<td style="text-align:left">bigint   PK</td>
</tr>
<tr>
<td style="text-align:left">xid</td>
<td style="text-align:left">varchar(100)</td>
</tr>
<tr>
<td style="text-align:left">context</td>
<td style="text-align:left">varchar(128)</td>
</tr>
<tr>
<td style="text-align:left">rollback_info</td>
<td style="text-align:left">longblob</td>
</tr>
<tr>
<td style="text-align:left">log_status</td>
<td style="text-align:left">tinyint</td>
</tr>
<tr>
<td style="text-align:left">log_created</td>
<td style="text-align:left">datetime</td>
</tr>
<tr>
<td style="text-align:left">log_modified</td>
<td style="text-align:left">datetime</td>
</tr>
</tbody>
</table>
<pre><code class="language-sql">-- 注意此处0.7.0+ 增加字段 context
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
</code></pre>
<h3 id="tcc-模式">TCC 模式</h3>
<p>回顾总览中的描述：一个分布式的全局事务，整体是 <strong>「两阶段提交」</strong> 的模型。全局事务是由若干分支事务组成的，分支事务要满足 <strong>「两阶段提交」</strong> 的模型要求，即需要每个分支事务都具备自己的：</p>
<ul>
<li>一阶段 prepare 行为</li>
<li>二阶段 commit 或 rollback 行为</li>
</ul>
<figure data-type="image" tabindex="5"><img src="https://tinaxiawuhao.github.io/post-images/1659011856143.png" alt="" loading="lazy"></figure>
<p>根据两阶段行为模式的不同，我们将分支事务划分为 <strong>「Automatic (Branch) Transaction Mode」</strong> 和 <strong>「Manual (Branch) Transaction Mode」</strong>.</p>
<p>AT 模式（参考链接 TBD）基于 <strong>「支持本地 ACID 事务」</strong> 的 <strong>「关系型数据库」</strong>：</p>
<ul>
<li>一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录。</li>
<li>二阶段 commit 行为：马上成功结束，<strong>「自动」</strong> 异步批量清理回滚日志。</li>
<li>二阶段 rollback 行为：通过回滚日志，<strong>「自动」</strong> 生成补偿操作，完成数据回滚。</li>
</ul>
<p>相应的，TCC 模式，不依赖于底层数据资源的事务支持：</p>
<ul>
<li>一阶段 prepare 行为：调用 <strong>「自定义」</strong> 的 prepare 逻辑。</li>
<li>二阶段 commit 行为：调用 <strong>「自定义」</strong> 的 commit 逻辑。</li>
<li>二阶段 rollback 行为：调用 <strong>「自定义」</strong> 的 rollback 逻辑。</li>
</ul>
<p>所谓 TCC 模式，是指支持把 <strong>「自定义」</strong> 的分支事务纳入到全局事务的管理中。</p>
<h3 id="saga-模式">Saga 模式</h3>
<p>Saga模式是SEATA提供的长事务解决方案，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。</p>
<figure data-type="image" tabindex="6"><img src="https://tinaxiawuhao.github.io/post-images/1659011864916.png" alt="" loading="lazy"></figure>
<p>理论基础：Hector &amp; Kenneth 发表论⽂ Sagas （1987）</p>
<h4 id="适用场景">适用场景</h4>
<ul>
<li>业务流程长、业务流程多</li>
<li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</li>
</ul>
<h4 id="优势">优势</h4>
<ul>
<li>一阶段提交本地事务，无锁，高性能</li>
<li>事件驱动架构，参与者可异步执行，高吞吐</li>
<li>补偿服务易于实现</li>
</ul>
<h4 id="缺点">缺点</h4>
<ul>
<li>不保证隔离性</li>
</ul>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#seata-%E6%98%AF%E4%BB%80%E4%B9%88">Seata 是什么?</a></li>
<li><a href="#at-%E6%A8%A1%E5%BC%8F">AT 模式</a>
<ul>
<li><a href="#%E5%89%8D%E6%8F%90">前提</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6">整体机制</a></li>
<li><a href="#%E5%86%99%E9%9A%94%E7%A6%BB">写隔离</a></li>
<li><a href="#%E8%AF%BB%E9%9A%94%E7%A6%BB">读隔离</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">工作机制</a></li>
<li><a href="#%E9%99%84%E5%BD%95">附录</a></li>
</ul>
</li>
<li><a href="#tcc-%E6%A8%A1%E5%BC%8F">TCC 模式</a></li>
<li><a href="#saga-%E6%A8%A1%E5%BC%8F">Saga 模式</a>
<ul>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF">适用场景</a></li>
<li><a href="#%E4%BC%98%E5%8A%BF">优势</a></li>
<li><a href="#%E7%BC%BA%E7%82%B9">缺点</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
          
              <hr />
            
          
            
            <p class="next-post">上一篇：
                <a href="https://tinaxiawuhao.github.io/post/WLM-Ra1r4/">
                  <span class="post-title">
                    服务容错：服务雪崩与容错方案&rarr;
                  </span>
                </a>
              </p>
            
          
            
           <p class="prev-post">下一篇：
                 <a href="https://tinaxiawuhao.github.io/post/IMU3BaL0b/">
                   <span class="post-title">
                     搭建并整合Seata&rarr;
                   </span>
                 </a>
               </p>
          
          <div class="comment" style="text-align: center;">
            

            
            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/tinaxiawuhao" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://tinaxiawuhao.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>tianxia</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/clean-blog.min.js"></script> -->
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="240" height="250" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //移动端
        console.log("------ 移动端");
    } else {
        console.log("------ PC端 " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // 加载完成后再loadlive2d
            loadlive2d("live2d", "https://tinaxiawuhao.github.io/media/live2d/assets/tororo.model.json");
        });

        var home_Path = "https://tinaxiawuhao.github.io/";
        addScript("https://tinaxiawuhao.github.io/media/live2d/js/message.js", () => { });
    }

    // 插入js文件，完成后callback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();如果传递字符串过来 调用window['函数名']() 调用方法
                }
            }
        };
    }
</script>
  
  <script src="https://tinaxiawuhao.github.io/media/scripts/tocScript.js"></script>
</body>

</html>