<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="欢迎访问[tianxia]的个人博客">
<meta name="author" content="kveln">
<title>搭建并整合Seata | tianxia</title>
<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/bootstrap.min.css">
<link href="https://tinaxiawuhao.github.io/resource/all.min.css" rel="stylesheet">
<link rel="alternate" type="application/rss+xml" title="搭建并整合Seata | tianxia » Feed"
  href="https://tinaxiawuhao.github.io/atom.xml">
<link rel="stylesheet"
  href="https://tinaxiawuhao.github.io/resource/androidstudio.min.css">
<link href="https://tinaxiawuhao.github.io/styles/main.css" rel="stylesheet">
<script src="https://tinaxiawuhao.github.io/resource/jquery.min.js"></script>

<script src="https://tinaxiawuhao.github.io/resource/highlight.min.js"></script>

<link rel="stylesheet" href="https://tinaxiawuhao.github.io/resource/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

  <meta property="og:description" content="搭建并整合Seata" />
  <meta property="og:url" content="https://tinaxiawuhao.github.io/post/IMU3BaL0b/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="tianxia" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1663409015113"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://tinaxiawuhao.github.io">tianxia</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1663409015113"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://tinaxiawuhao.github.io/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- 没Title为其他页面Header -->
          
            <!-- 没Title并且有headerType为Post：文章Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://tinaxiawuhao.github.io/tag/PvdavFGm6/" class="tag">springCloud</a>
                
              </span>
              <h1>搭建并整合Seata</h1>
              <span class="meta">
                Posted on
                2022-07-19，17 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <img class="post-feature-header-image" src="https://tinaxiawuhao.github.io/post-images/IMU3BaL0b.png" alt="封面图">
          </img>
          
          <h3 id="搭建并整合seata">搭建并整合Seata</h3>
<p>接下来，我们就正式在项目中整合Seata来实现分布式事务。这里，我们主要整合Seata的AT模式。</p>
<h4 id="搭建seata基础环境">搭建Seata基础环境</h4>
<p>（1）到https://github.com/seata/seata/releases/tag/v1.4.2链接下载Seata的安装包和源码，这里，下载的是1.4.2版本，如下所示。</p>
<figure data-type="image" tabindex="1"><img src="https://tinaxiawuhao.github.io/post-images/1659012100579.png" alt="" loading="lazy"></figure>
<p>这里我下载的都是zip压缩文件。</p>
<p>（2）进入Nacos，选择的命名空间，如下所示。</p>
<figure data-type="image" tabindex="2"><img src="https://tinaxiawuhao.github.io/post-images/1659012119037.png" alt="" loading="lazy"></figure>
<p>点击新建命名空间，并填写Seata相关的信息，如下所示。</p>
<figure data-type="image" tabindex="3"><img src="https://tinaxiawuhao.github.io/post-images/1659012136201.png" alt="" loading="lazy"></figure>
<p>可以看到，这里我填写的信息如下所示。</p>
<ul>
<li>命名空间ID：seata_namespace_001，如果不填的话Nacos会自动生成命名空间的ID。</li>
<li>命名空间名：seata。</li>
<li>描述：seata的命名空间。</li>
</ul>
<p><strong>「这里，需要记录下命名空间的ID：seata_namespace_001，在后面的配置中会使用到。」</strong></p>
<p>点击确定后如下所示。</p>
<figure data-type="image" tabindex="4"><img src="https://tinaxiawuhao.github.io/post-images/1659012154952.png" alt="" loading="lazy"></figure>
<p>可以看到，这里为Seata在Nacos中创建了命名空间。</p>
<p>（3）解压Seata安装文件，进入解压后的<code>seata/seata-server-1.4.2/conf</code>目录，修改<code>registry.conf</code>注册文件，修改后的部分文件内容如下所示。</p>
<pre><code class="language-java">registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;nacos&quot;

  nacos {
    application = &quot;seata-server&quot;
    serverAddr = &quot;127.0.0.1:8848&quot;
    group = &quot;SEATA_GROUP&quot;
    namespace = &quot;seata_namespace_001&quot;
    cluster = &quot;default&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
}

config {
  # file、nacos 、apollo、zk、consul、etcd3
  type = &quot;nacos&quot;

  nacos {
    serverAddr = &quot;127.0.0.1:8848&quot;
    namespace = &quot;seata_namespace_001&quot;
    group = &quot;SEATA_GROUP&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
    dataId = &quot;seataServer.properties&quot;
  }
}
</code></pre>
<p>其中，namespace的值就是在Nacos中配置的Seata的命名空间ID：seata_namespace_001。</p>
<p><strong>「注意：这里只列出了修改的部分内容，完整的registry.conf文件可以到项目的<code>doc/nacos/config/chapter25</code>目录下获取。」</strong></p>
<p>（4）修改Seata安装文件的<code>seata/seata-server-1.4.2/conf</code>目录下的file.conf文件，修改后的部分配置如下所示。</p>
<pre><code class="language-java">store {
  mode = &quot;db&quot;
  publicKey = &quot;&quot;
  db {
    datasource = &quot;druid&quot;
    dbType = &quot;mysql&quot;
    driverClassName = &quot;com.mysql.jdbc.Driver&quot;
    url = &quot;jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai&quot;
    user = &quot;root&quot;
    password = &quot;root&quot;
    minConn = 5
    maxConn = 100
    globalTable = &quot;global_table&quot;
    branchTable = &quot;branch_table&quot;
    lockTable = &quot;lock_table&quot;
    queryLimit = 100
    maxWait = 5000
  }
}
</code></pre>
<p><strong>「注意：这里只列出了修改的部分内容，完整的file.conf文件可以到项目的<code>doc/nacos/config/chapter25</code>目录下获取。」</strong></p>
<p>（5）在下载的Seata源码的<code>seata-1.4.2/script/config-center</code>目录下找到config.txt文件，如下所示。</p>
<figure data-type="image" tabindex="5"><img src="https://tinaxiawuhao.github.io/post-images/1659012175639.png" alt="" loading="lazy"></figure>
<p>将其复制到Seata安装包解压的根目录下，如下所示。</p>
<figure data-type="image" tabindex="6"><img src="https://tinaxiawuhao.github.io/post-images/1659012194228.png" alt="" loading="lazy"></figure>
<p>接下来，修改Seata安装包解压的根目录下的config.txt文件，这里还是只列出修改的部分，如下所示。</p>
<pre><code class="language-java">service.vgroupMapping.server-order-tx_group=default
service.vgroupMapping.server-product-tx_group=default
store.mode=db
store.publicKey=&quot;&quot;
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai
store.db.user=root
store.db.password=root
store.redis.sentinel.masterName=&quot;&quot;
store.redis.sentinel.sentinelHosts=&quot;&quot;
store.redis.password=&quot;&quot;
</code></pre>
<p><strong>「注意：在config.txt中，部分配置的等号“=”后面为空，需要在等号“=“后面添加空字符串&quot;&quot;。同样的，小伙伴们可以到项目的<code>doc/nacos/config/chapter25</code>目录下获取完整的config.txt文件。」</strong></p>
<p>（6）在下载的Seata源码的<code>seata-1.4.2/script/config-center/nacos</code>目录下找到nacos-config.sh文件，如下所示。</p>
<figure data-type="image" tabindex="7"><img src="https://tinaxiawuhao.github.io/post-images/1659012213383.png" alt="" loading="lazy"></figure>
<p>将nacos-config.sh文件复制到Seata安装文件解压目录的<code>seata/seata-server-1.4.2/scripts</code>目录下，其中scripts目录需要手动创建，如下所示。</p>
<figure data-type="image" tabindex="8"><img src="https://tinaxiawuhao.github.io/post-images/1659012230067.png" alt="" loading="lazy"></figure>
<p>（7）.sh文件是Linux操作系统上的脚本文件，如果想在Windows操作系统上运行.sh文件，可以在Windows操作系统上安装Git后在运行.sh文件。</p>
<p>接下来，在Git的Bash命令行进入Seata安装文件中nacos-config.sh文件所在的目录，执行如下命令。</p>
<pre><code class="language-shell">sh nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -t seata_namespace_001 -u nacos -w nacos
</code></pre>
<p>其中，命令中的每个参数含义如下所示。</p>
<ul>
<li>-h：Nacos所在的IP地址。</li>
<li>-p：Nacos的端口号。</li>
<li>-g：分组。</li>
<li>-t：命名空间的ID，这里我们填写在Nacos中创建的命名空间的ID：seata_namespace_001。如果不填，默认是public命名空间。</li>
<li>-u：Nacos的用户名。</li>
<li>-w：Nacos的密码。</li>
</ul>
<p>执行命令后的结果信息如下所示。</p>
<pre><code class="language-java">=========================================================================
 Complete initialization parameters,  total-count:89 ,  failure-count:0
=========================================================================
 Init nacos config finished, please start seata-server.
</code></pre>
<p>可以看到，整个配置执行成功。</p>
<p>（8）打开Nacos的配置管理-配置列表界面，切换到seata命名空间，可以看到有关Seata的配置都注册到Nacos中了，如下所示。</p>
<figure data-type="image" tabindex="9"><img src="https://tinaxiawuhao.github.io/post-images/1659012247957.png" alt="" loading="lazy"></figure>
<p>（9）在MySQL数据库中创建seata数据库，如下所示。</p>
<pre><code class="language-sql">create database if not exists seata;
</code></pre>
<p>接下来，在seata数据库中执行Seata源码包<code>seata-1.4.2/script/server/db</code>目录下的mysql.sql脚本文件，mysql.sql脚本的内容如下所示。</p>
<pre><code class="language-sql">-- -------------------------------- The script used when storeMode is 'db' --------------------------------
-- the table to store GlobalSession data
CREATE TABLE IF NOT EXISTS `global_table`
(
    `xid`                       VARCHAR(128) NOT NULL,
    `transaction_id`            BIGINT,
    `status`                    TINYINT      NOT NULL,
    `application_id`            VARCHAR(32),
    `transaction_service_group` VARCHAR(32),
    `transaction_name`          VARCHAR(128),
    `timeout`                   INT,
    `begin_time`                BIGINT,
    `application_data`          VARCHAR(2000),
    `gmt_create`                DATETIME,
    `gmt_modified`              DATETIME,
    PRIMARY KEY (`xid`),
    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),
    KEY `idx_transaction_id` (`transaction_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;

-- the table to store BranchSession data
CREATE TABLE IF NOT EXISTS `branch_table`
(
    `branch_id`         BIGINT       NOT NULL,
    `xid`               VARCHAR(128) NOT NULL,
    `transaction_id`    BIGINT,
    `resource_group_id` VARCHAR(32),
    `resource_id`       VARCHAR(256),
    `branch_type`       VARCHAR(8),
    `status`            TINYINT,
    `client_id`         VARCHAR(64),
    `application_data`  VARCHAR(2000),
    `gmt_create`        DATETIME(6),
    `gmt_modified`      DATETIME(6),
    PRIMARY KEY (`branch_id`),
    KEY `idx_xid` (`xid`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;

-- the table to store lock data
CREATE TABLE IF NOT EXISTS `lock_table`
(
    `row_key`        VARCHAR(128) NOT NULL,
    `xid`            VARCHAR(128),
    `transaction_id` BIGINT,
    `branch_id`      BIGINT       NOT NULL,
    `resource_id`    VARCHAR(256),
    `table_name`     VARCHAR(32),
    `pk`             VARCHAR(36),
    `gmt_create`     DATETIME,
    `gmt_modified`   DATETIME,
    PRIMARY KEY (`row_key`),
    KEY `idx_branch_id` (`branch_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
</code></pre>
<p>这里，也将mysql.sql文件放在了项目的<code>doc/nacos/config/chapter25</code>目录下。</p>
<p>（10）启动Seata服务，进入在命令行进入Seata安装文件的<code>seata/seata-server-1.4.2/bin</code>目录，执行如下命令。</p>
<pre><code class="language-shell">seata-server.bat -p 8091 -h 127.0.0.1 -m db
</code></pre>
<p>可以看到，在启动Seata的命令行输出了如下信息。</p>
<pre><code class="language-java">i.s.core.rpc.netty.NettyServerBootstrap  : Server started, listen port: 8091
</code></pre>
<p>说明Seata已经启动成功。</p>
<p>至此，Seata的基础环境搭建完毕。</p>
<h4 id="项目整合seata">项目整合Seata</h4>
<p>在我们开发的微服务程序中，订单微服务下单成功后会调用库存微服务扣减商品的库存信息，而用户微服务只提供了查询用户信息的接口。这里，我们在商品微服务和订单微服务中整合Seata。</p>
<h4 id="导入unlog表">导入unlog表</h4>
<p>我们使用的是Seata的AT模式，需要我们在涉及到使用Seata解决分布式事务问题的每个业务库中创建一个Seata的undo_log数据表，Seata中本身提供了创建数据表的SQL文件，这些SQL文件位于Seata源码包下的<code>seata-1.4.2/script/client/at/db</code>目录中，如下所示。</p>
<figure data-type="image" tabindex="10"><img src="https://tinaxiawuhao.github.io/post-images/1659012267689.png" alt="" loading="lazy"></figure>
<p>这里，我们使用mysql.sql脚本。mysql.sql脚本的内容如下所示。</p>
<pre><code class="language-sql">-- for AT mode you must to init this sql for you business database. the seata server not need it.
CREATE TABLE IF NOT EXISTS `undo_log`
(
    `branch_id`     BIGINT       NOT NULL COMMENT 'branch transaction id',
    `xid`           VARCHAR(128) NOT NULL COMMENT 'global transaction id',
    `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization',
    `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',
    `log_status`    INT(11)      NOT NULL COMMENT '0:normal status,1:defense status',
    `log_created`   DATETIME(6)  NOT NULL COMMENT 'create datetime',
    `log_modified`  DATETIME(6)  NOT NULL COMMENT 'modify datetime',
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8 COMMENT ='AT transaction mode undo table';
</code></pre>
<p>注意，这里要在shop数据库中执行mysql.sql脚本，同样的，我会将这里的mysql.sql文件放到项目的<code>doc/nacos/config/chapter25</code>目录下，并重命名为mysql_client.sql。</p>
<h4 id="商品微服务整合seata">商品微服务整合Seata</h4>
<p>（1）在商品微服务shop-product的pom.xml文件中引入Seata依赖，如下所示。</p>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>（2）修改商品微服务shop-product的bootstrap.yml，修改后的文件如下所示。</p>
<pre><code class="language-java">spring:
  application:
    name: server-product
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yaml
        group: product_group
        shared-configs[0]:
          data_id: server-all.yaml
          group: all_group
          refresh: true
      discovery:
        server-addr: 127.0.0.1:8848
    alibaba:
      seata:
        tx-service-group: ${spring.application.name}-tx_group

  profiles:
    active: dev

seata:
  application-id: ${spring.application.name}
  service:
    vgroup-mapping:
      server-product-tx_group: default

  registry:
    nacos:
      server-addr: ${spring.cloud.nacos.discovery.server-addr}
      username: nacos
      password: nacos
      group: SEATA_GROUP
      namespace: seata_namespace_001
      application: seata-server

  config:
    type: nacos
    nacos:
      server-addr: ${spring.cloud.nacos.discovery.server-addr}
      username: nacos
      password: nacos
      group: SEATA_GROUP
      namespace: seata_namespace_001
</code></pre>
<p>其中，配置的Nacos的namespace与group与<code>registry.conf</code>文件中的一致。</p>
<h4 id="订单微服务整合seata">订单微服务整合Seata</h4>
<p>（1）在订单微服务shop-product的pom.xml文件中引入Seata依赖，如下所示。</p>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>（2）修改订单微服务shop-order的bootstrap.yml，修改后的文件如下所示。</p>
<pre><code class="language-java">spring:
  application:
    name: server-order
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yaml
        group: order_group
        shared-configs[0]:
          data_id: server-all.yaml
          group: all_group
          refresh: true
      discovery:
        server-addr: 127.0.0.1:8848
    alibaba:
      seata:
        tx-service-group: ${spring.application.name}-tx_group

  profiles:
    active: dev

seata:
  application-id: ${spring.application.name}
  service:
    vgroup-mapping:
      server-order-tx_group: default

  registry:
    nacos:
      server-addr: ${spring.cloud.nacos.discovery.server-addr}
      username: nacos
      password: nacos
      group: SEATA_GROUP
      namespace: seata_namespace_001
      application: seata-server

  config:
    type: nacos
    nacos:
      server-addr: ${spring.cloud.nacos.discovery.server-addr}
      username: nacos
      password: nacos
      group: SEATA_GROUP
      namespace: seata_namespace_001
</code></pre>
<p>（3）修改订单微服务的<code>io.binghe.shop.order.service.impl.OrderServiceV8Impl</code>类的saveOrder()方法，在saveOrder()方法上添加Seata的@GlobalTransactional注解，如下所示。</p>
<pre><code class="language-java">@Override
@GlobalTransactional
public void saveOrder(OrderParams orderParams) {
 //省略具体方法代码
}
</code></pre>
<p>至此，搭建并整合Seata完毕，就是这么简单。</p>
<h3 id="验证seata事务">验证Seata事务</h3>
<h4 id="重置数据库数据">重置数据库数据</h4>
<p>这里，首先将商品数据表t_product中id为1001的数据的库存信息重置为100，如下所示。</p>
<pre><code class="language-sql">update t_product set t_pro_stock = 100 where id = 1001;
</code></pre>
<h4 id="查询数据表数据">查询数据表数据</h4>
<p>（1）打开cmd终端，进入MySQL命令行，并进入shop商城数据库，如下所示。</p>
<pre><code class="language-shell">C:\Users\binghe&gt;mysql -uroot -p
Enter password: ****
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 15
Server version: 5.7.35 MySQL Community Server (GPL)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; use shop;
Database changed
</code></pre>
<p>（2）查看商品数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_product;
+------+------------+-------------+-------------+
| id   | t_pro_name | t_pro_price | t_pro_stock |
+------+------------+-------------+-------------+
| 1001 | 华为       |     2399.00 |         100 |
| 1002 | 小米       |     1999.00 |         100 |
| 1003 | iphone     |     4999.00 |         100 |
+------+------------+-------------+-------------+
3 rows in set (0.00 sec)
</code></pre>
<p>这里，我们以id为1001的商品为例，此时发现商品的库存为100。</p>
<p>（3）查询订单数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_order;
Empty set (0.00 sec)
</code></pre>
<p>可以发现订单数据表为空。</p>
<p>（4）查询订单条目数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_order_item;
Empty set (0.00 sec)
</code></pre>
<p>可以看到，订单条目数据表为空。</p>
<h4 id="验证seata事务-2">验证Seata事务</h4>
<p>（1）分别启动Nacos、Sentinel、ZinKin、RocketMQ，Seata，并启动用户微服务，商品微服务，订单微服务和服务网关。打开浏览器访问<code>http://localhost:10001/server-order/order/submit_order?userId=1001&amp;productId=1001&amp;count=1</code>，如下所示。</p>
<figure data-type="image" tabindex="11"><img src="https://tinaxiawuhao.github.io/post-images/1659012289306.png" alt="" loading="lazy"></figure>
<p>返回的原始数据如下所示。</p>
<pre><code class="language-java">{&quot;code&quot;:500,&quot;codeMsg&quot;:&quot;执行失败&quot;,&quot;data&quot;:&quot;/ by zero&quot;}
</code></pre>
<p>（2）查看各个微服务和网关输出的日志信息，分别如下所示。</p>
<ul>
<li>用户微服务输出的日志如下所示。</li>
</ul>
<pre><code class="language-java">获取到的用户信息为：{&quot;address&quot;:&quot;北京&quot;,&quot;id&quot;:1001,&quot;password&quot;:&quot;c26be8aaf53b15054896983b43eb6a65&quot;,&quot;phone&quot;:&quot;13212345678&quot;,&quot;username&quot;:&quot;binghe&quot;}
</code></pre>
<p>说明用户微服务无异常信息。</p>
<ul>
<li>商品微服务输出的日志如下所示。</li>
</ul>
<pre><code class="language-java">获取到的商品信息为：{&quot;id&quot;:1001,&quot;proName&quot;:&quot;华为&quot;,&quot;proPrice&quot;:2399.00,&quot;proStock&quot;:100}
更新商品库存传递的参数为: 商品id:1001, 购买数量:1 
</code></pre>
<p>说明商品微服务无异常信息。</p>
<p>值得注意的是，整合Seata后，商品微服务同时输出了如下日志。</p>
<pre><code class="language-shell">rm handle branch rollback process:xid=192.168.0.111:8091:6638572304823066625,branchId=6638572304823066634,branchType=AT,resourceId=jdbc:mysql://localhost:3306/shop,applicationData=null
Branch Rollbacking: 192.168.0.111:8091:6638572304823066625 6638572304823066634 jdbc:mysql://localhost:3306/shop
xid 192.168.0.111:8091:6638572304823066625 branch 6638572304823066634, undo_log deleted with GlobalFinished
Branch Rollbacked result: PhaseTwo_Rollbacked
</code></pre>
<p>看上去应该是有事务回滚了。</p>
<ul>
<li>订单微服务输出的日志如下所示。</li>
</ul>
<pre><code class="language-java">提交订单时传递的参数:{&quot;count&quot;:1,&quot;empty&quot;:false,&quot;productId&quot;:1001,&quot;userId&quot;:1001}
库存扣减成功
服务器抛出了异常：{}
java.lang.ArithmeticException: / by zero
</code></pre>
<p>说明订单微服务抛出了ArithmeticException异常。</p>
<p>同时，商品微服务会输出如下日志。</p>
<pre><code class="language-java">Branch Rollbacked result: PhaseTwo_Rollbacked
[192.168.0.111:8091:6638572304823066625] rollback status: Rollbacked
</code></pre>
<p>看上去应该是有事务回滚了。</p>
<ul>
<li>网关服务输出的日志如下所示。</li>
</ul>
<pre><code class="language-java">执行前置过滤器逻辑
执行后置过滤器逻辑
访问接口主机: localhost
访问接口端口: 10001
访问接口URL: /server-order/order/submit_order
访问接口URL参数: userId=1001&amp;productId=1001&amp;count=1
访问接口时长: 1632ms
</code></pre>
<p>可以看到，网关服务无异常信息。</p>
<p>通过微服务打印出的日志信息，可以看到，有事务回滚了。</p>
<h4 id="查询数据表数据-2">查询数据表数据</h4>
<p>（1）打开cmd终端，进入MySQL命令行，并进入shop商城数据库，如下所示。</p>
<pre><code class="language-shell">C:\Users\binghe&gt;mysql -uroot -p
Enter password: ****
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 15
Server version: 5.7.35 MySQL Community Server (GPL)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; use shop;
Database changed
</code></pre>
<p>（2）查看商品数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_product;
+------+------------+-------------+-------------+
| id   | t_pro_name | t_pro_price | t_pro_stock |
+------+------------+-------------+-------------+
| 1001 | 华为       |     2399.00 |         100 |
| 1002 | 小米       |     1999.00 |         100 |
| 1003 | iphone     |     4999.00 |         100 |
+------+------------+-------------+-------------+
3 rows in set (0.00 sec)
</code></pre>
<p>可以看到，此时商品数据表中，id为1001的商品库存数量仍然为100。</p>
<p>（3）查看订单数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_order;
Empty set (0.00 sec)
</code></pre>
<p>可以看到，订单数据表为空。</p>
<p>（4）查看订单条目数据表，如下所示。</p>
<pre><code class="language-shell">mysql&gt; select * from t_order_item;
Empty set (0.00 sec)
</code></pre>
<p>可以看到，订单条目数据表为空。</p>
<p>至此，我们成功在项目中整合了Seata解决了分布式事务的问题</p>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E6%90%AD%E5%BB%BA%E5%B9%B6%E6%95%B4%E5%90%88seata">搭建并整合Seata</a>
<ul>
<li><a href="#%E6%90%AD%E5%BB%BAseata%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83">搭建Seata基础环境</a></li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88seata">项目整合Seata</a></li>
<li><a href="#%E5%AF%BC%E5%85%A5unlog%E8%A1%A8">导入unlog表</a></li>
<li><a href="#%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88seata">商品微服务整合Seata</a></li>
<li><a href="#%E8%AE%A2%E5%8D%95%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88seata">订单微服务整合Seata</a></li>
</ul>
</li>
<li><a href="#%E9%AA%8C%E8%AF%81seata%E4%BA%8B%E5%8A%A1">验证Seata事务</a>
<ul>
<li><a href="#%E9%87%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE">重置数据库数据</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E8%A1%A8%E6%95%B0%E6%8D%AE">查询数据表数据</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81seata%E4%BA%8B%E5%8A%A1-2">验证Seata事务</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E8%A1%A8%E6%95%B0%E6%8D%AE-2">查询数据表数据</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
          
              <hr />
            
          
            
            <p class="next-post">上一篇：
                <a href="https://tinaxiawuhao.github.io/post/XFKzbOO8H/">
                  <span class="post-title">
                    Seata&rarr;
                  </span>
                </a>
              </p>
            
          
            
           <p class="prev-post">下一篇：
                 <a href="https://tinaxiawuhao.github.io/post/8FPjAXq14/">
                   <span class="post-title">
                     消息服务：MQ使用场景与选型对比&rarr;
                   </span>
                 </a>
               </p>
          
          <div class="comment" style="text-align: center;">
            

            
            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/tinaxiawuhao" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://tinaxiawuhao.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>tianxia</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://tinaxiawuhao.github.io/media/scripts/clean-blog.min.js"></script> -->
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="240" height="250" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //移动端
        console.log("------ 移动端");
    } else {
        console.log("------ PC端 " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // 加载完成后再loadlive2d
            loadlive2d("live2d", "https://tinaxiawuhao.github.io/media/live2d/assets/tororo.model.json");
        });

        var home_Path = "https://tinaxiawuhao.github.io/";
        addScript("https://tinaxiawuhao.github.io/media/live2d/js/message.js", () => { });
    }

    // 插入js文件，完成后callback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();如果传递字符串过来 调用window['函数名']() 调用方法
                }
            }
        };
    }
</script>
  
  <script src="https://tinaxiawuhao.github.io/media/scripts/tocScript.js"></script>
</body>

</html>